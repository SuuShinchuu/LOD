<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Get Your Loot üßô‚Äç‚ôÇÔ∏è</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcFbVX7eh98iQ71E6GjWF40ai-qWPVTY8",
      authDomain: "getyourloot-ab15a.firebaseapp.com",
      databaseURL: "https://getyourloot-ab15a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "getyourloot-ab15a",
      storageBucket: "getyourloot-ab15a.appspot.com",
      messagingSenderId: "398987786235",
      appId: "1:398987786235:web:17c236affdb8e920cabd5e",
      measurementId: "G-30056BD62B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const clientId = crypto.randomUUID();

    const tablaObjetos = [
      "Staff of Courage",
      "Medallion of Resistance",
      "Boots of Silent Path",
      "Challenger's Sash",
      "Ring of Quick Reaction",
      "Guard's Dagger",
      "Veteran's Lucky Coin",
      "Bracers of Reflexes",
      "Belt of Endurance",
      "Staff of Minor Power",
      "Ring of Evasive Escape",
      "Bracelet of Shielding",
      "Bracers +2 AC",
      "Gloves of Firm Grip",
      "Cloak of the Charlatan",
      "Staff of Insect Swarm",
      "Cloak of Shadows",
      "Ring of Controlled Fury",
      "Shield of Resistance",
      "Lesser Executioner's Weapon",
      "Staff of Greater Power"
    ];

    const pociones = {
      infrecuente: [
        "Potion of Fire Breath",
        "Potion of Growth",
        "2x Greater Healing Potion",
        "Potion of Resistance",
        "Potion of Water Breathing",
        "Poison Potion"
      ],
      rara: [
        "Potion of Gaseous Form",
        "Potion of Frost Giant Strength",
        "Potion of Heroism",
        "Potion of Invisibility",
        "Potion of Invulnerability",
        "2x Greater Healing Potion"
      ],
      muy_rara: [
        "Potion of Enhanced Resistance",
        "Potion of Haste",
        "Potion of Levitation",
        "Potion of Flying",
        "2x Full Healing Potion",
        "Storm Giant's Potion"
      ]
    };

    let isAnimating = false;

    function tirar(tipo) {
      if (tipo === 'objeto') {
        const resultadoRef = ref(db, `tiradas/objeto`);
        set(resultadoRef, {
          estado: 'tirando',
          startedAt: Date.now(),
          startedBy: clientId
        });
      }
    }

    function animarTiradaObjeto(callback) {
      if (isAnimating) return;
      isAnimating = true;
      let i = 0;
      const vueltas = 30 + Math.floor(Math.random() * 20);
      const div = document.getElementById("resultado-objeto");
      const intervalo = setInterval(() => {
        const index = i % tablaObjetos.length;
        div.innerHTML = `<strong>${tablaObjetos[index]}</strong>`;
        i++;
        if (i > vueltas) {
          clearInterval(intervalo);
          isAnimating = false;
          if (callback) callback();
        }
      }, 75);
    }

    function finalizarTiradaObjeto() {
      const resultadoRef = ref(db, `tiradas/objeto`);
      const tirada = Math.floor(Math.random() * tablaObjetos.length);
      const objeto = tablaObjetos[tirada];
      set(resultadoRef, {
        estado: 'resultado',
        tirada: tirada + 1,
        objeto
      });
    }

    function actualizarVista(tipo) {
      const resultadoRef = ref(db, `tiradas/${tipo}`);
      onValue(resultadoRef, (snapshot) => {
        const data = snapshot.val();
        const div = document.getElementById(`resultado-${tipo}`);
        if (!data) {
          div.innerHTML = "No roll yet.";
          return;
        }

        if (tipo === "objeto") {
          if (data.estado === 'tirando') {
            animarTiradaObjeto(() => {
              if (data.startedBy === clientId) {
                finalizarTiradaObjeto();
              }
            });
          } else if (data.estado === 'resultado') {
            if (!isAnimating) {
              div.innerHTML = `<strong>${data.objeto}</strong>`;
            } else {
              setTimeout(() => {
                div.innerHTML = `<strong>${data.objeto}</strong>`;
              }, 2500);
            }
          }
        } else if (tipo === "pocion") {
          if (data.paso === 1) {
            ultimaTipo = data.tipo;
            div.innerHTML = `Roll: ${data.tiradaTipo}<br>Type: <strong>${data.tipo}</strong><br><button onclick='tirarPocionFinal()'>Roll 1d6</button>`;
          } else if (data.paso === 2) {
            div.innerHTML = `Potion obtained: <strong>${data.resultadoFinal}</strong>`;
          } else {
            div.innerHTML = "Ready to roll.";
          }
        }
      });
    }

    function tirarPocion() {
      const tiradaTipo = Math.floor(Math.random() * 20) + 1;
      let tipo;
      if (tiradaTipo <= 10) tipo = "infrecuente";
      else if (tiradaTipo <= 16) tipo = "rara";
      else tipo = "muy_rara";

      const resultadoRef = ref(db, `tiradas/pocion`);
      set(resultadoRef, { tiradaTipo, tipo, paso: 1 });
    }

    function tirarPocionFinal() {
      const dado = Math.floor(Math.random() * 6);
      const resultadoRef = ref(db, `tiradas/pocion`);
      set(resultadoRef, { tiradaTipo: null, tipo: null, resultadoFinal: pociones[ultimaTipo][dado], paso: 2 });
    }

    function resetear(tipo) {
      const resultadoRef = ref(db, `tiradas/${tipo}`);
      remove(resultadoRef);
    }

    let ultimaTipo = null;

    window.tirar = tirar;
    window.tirarPocion = tirarPocion;
    window.tirarPocionFinal = tirarPocionFinal;
    window.resetear = resetear;

    window.onload = () => {
      actualizarVista('objeto');
      actualizarVista('pocion');
    };
  </script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f2f2f2;
      padding: 2rem;
    }
    h2 {
      margin-top: 2rem;
    }
    button {
      padding: 1rem 2rem;
      font-size: 1rem;
      margin: 1rem;
      cursor: pointer;
    }
    .resultado {
      font-size: 1.2rem;
      margin-top: 1rem;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
      display: inline-block;
      min-width: 200px;
      min-height: 60px;
    }
  </style>
</head>
<body>
  <h1>Get Your Loot üßô‚Äç‚ôÇÔ∏è</h1>

  <h2>Magic Item</h2>
  <button onclick="tirar('objeto')">Roll Magic Item</button>
  <button onclick="resetear('objeto')">Reset</button>
  <div id="resultado-objeto" class="resultado">Loading...</div>

  <h2>Potion</h2>
  <button onclick="tirarPocion()">Roll Potion Type</button>
  <button onclick="resetear('pocion')">Reset</button>
  <div id="resultado-pocion" class="resultado">Loading...</div>
</body>
</html>
